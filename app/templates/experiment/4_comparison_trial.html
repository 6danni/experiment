<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      media="screen"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <style>
      .dataset-container {
        display: flex;
        gap: 18px;
        margin: 16px 0;
      }
      .dataset-card {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 14px;
      }
      .dataset-card h3 {
        margin-top: 0;
      }
      .btn-wide {
        width: 100%;
        margin-top: 10px;
      }
      .meta {
        color: #777;
        font-size: 12px;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <div id="content" class="container" style="max-width: 800px">
      <h1>Your Scenario</h1>
      <div id="scenario-title"></div>
      <div id="scenario-text" class="text-justify"></div>

      <p class="lead" style="margin-top: 18px">
        Which dataset do you prefer for your modeling process?
      </p>

      <div id="dataset-pair" class="dataset-container"></div>

      <div class="meta">
        Trial <span id="trial-idx"></span> of <span id="trial-total"></span>
      </div>
    </div>

    <!-- Server boot data: exactly one trial at a time -->
    <script id="dataset-choice-data" type="application/json">
      {{ {
        "pid": pid,
        "scenario_id": scenario_id,
        "scenario": scenario,
        "trial_index": trial_index,
        "total_trials": total_trials,
        "trial": trial,
        "prior_decision": prior_decision,
        "next_url": url_for_pid('main.page_4_comparison_trial'),
        "done_url": url_for_pid('main.page_5_demographics')
      } | tojson }}
    </script>

    <script>
      const BOOT = JSON.parse(
        document.getElementById("dataset-choice-data").textContent
      );
      const {
        pid,
        scenario_id,
        scenario,
        trial_index,
        total_trials,
        trial,
        next_url,
        done_url,
      } = BOOT;

      // Scenario header
      (function renderScenario() {
        const title = document.getElementById("scenario-title");
        const h2 = document.createElement("h2");
        h2.textContent = scenario?.title || "Scenario";
        title.appendChild(h2);

        const text = document.getElementById("scenario-text");
        (scenario?.text || []).forEach((par) => {
          const p = document.createElement("p");
          p.textContent = par;
          text.appendChild(p);
        });
      })();

      function toInt(val) {
        if (val == null) return null;
        if (typeof val === "number") return Math.round(val);
        const s = String(val).trim().replace(/%/g, "");
        const num = Number(s);
        return Number.isFinite(num) ? Math.round(num) : null;
      }

      function formatPercent(val) {
        const n = val;
        return n == null ? "" : `${n}%`;
      }

      function plural(n, word) {
        return `${n} ${word}${n === 1 ? "" : "s"}`;
      }

      function formatCoverage(val) {
        const n = val;
        return n == null ? "" : `${n} potentially relevant data attributes`;
        
      }

      function formatFrequency(val) {
        if (val == null || val === "") return "";

        // Prefer explicit label if backend ever sends it
        if (typeof val === "string" && /day/i.test(val)) return val;

        // // Named frequency?
        // const nameMatch = typeof val === "string" && FREQ_NAME_TO_DAYS[val];
        // if (nameMatch)
        //   return `${val} (${plural(FREQ_NAME_TO_DAYS[val], "day")})`;

        // Numeric days (e.g., 7 or "7")
        const n = toInt(val);
        if (n != null) {
          // const name = DAYS_TO_FREQ_NAME[String(n)];
          return name ? `${name} (${plural(n, "day")})` : plural(n, "day");
        }

        // Fallback: show raw
        return String(val);
      }

      // Utility to render one dataset card
      function cardHTML(label, data) {
        console.log(data);
        const rec =
          data.recommendation_label ?? formatPercent(data.recommendation);
        const freq =
          data.frequency_label ??
          formatFrequency(data.frequency ?? data.frequency_days);
        const miss = data.missing_label ?? formatPercent(data.missing);
        const cov = data.coverage_label ?? formatCoverage(toInt(data.coverage));
        return `
        <div class="dataset-card" data-label="${label}">
        <h3>Dataset ${label}</h3>
        <ul>
          <li><strong>Recommendation:</strong> ${rec}</li>
          <li><strong>Frequency:</strong> ${freq}</li>
          <li><strong>Missing data rate:</strong> ${miss}</li>
          <li><strong>Coverage:</strong> ${cov}</li>
        </ul>
        <button class="btn btn-primary btn-wide" data-choose="${label}">
          Choose Dataset ${label}
        </button>
        </div>`;
      }

      // Render pair + trial progress
      (function renderPair() {
        document.getElementById("trial-idx").textContent = trial_index;
        document.getElementById("trial-total").textContent = total_trials;
        console.log(trial);
        const a = trial?.option_a || {};
        const b = trial?.option_b || {};
        const root = document.getElementById("dataset-pair");
        root.innerHTML = cardHTML("A", a) + cardHTML("B", b);

        root.addEventListener("click", async (e) => {
          const btn = e.target.closest("[data-choose]");
          if (!btn) return;
          await submitChoice(btn.getAttribute("data-choose"), a, b);
        });
      })();

      async function submitChoice(choice, aFeatures, bFeatures) {
        try {
          const res = await fetch("/api/prefs", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              pid,
              scenario_id,
              trial: trial_index, // 1-based
              choice, // "A" | "B"
              option_a: aFeatures,
              option_b: bFeatures,
            }),
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            alert(err.detail || `Save failed (${res.status})`);
            return;
          }
        } catch (e) {
          console.error(e);
          alert("Network error; please try again.");
          return;
        }

        // Advance to next or finish
        if (trial_index < total_trials) {
          window.location.href = next_url; // server will serve the next trial
        } else {
          window.location.href = done_url; // proceed to the next task
        }
      }
    </script>
  </body>
</html>
