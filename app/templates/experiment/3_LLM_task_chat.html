<div class="container" style="max-width: 820px">
  <h2 class="page-header">LLM Task</h2>

  <div
    id="chat"
    class="panel panel-default"
    style="height: 420px; overflow-y: auto; padding: 10px"
  >
    <!-- messages get injected here -->
  </div>

  <div class="input-group">
    <input
      id="msg"
      type="text"
      class="form-control"
      placeholder="Type your message…"
    />
    <span class="input-group-btn">
      <button id="send" class="btn btn-primary">Send</button>
    </span>
  </div>
  <small
    id="status"
    class="text-muted"
    style="display: block; margin-top: 6px"
  ></small>
  <button onclick="goToNextPage()">Next</button>
</div>

<!-- server-provided context -->
<script id="page-context" type="application/json">
  {{ {"pid": pid, "scenario_id": scenario_id}|tojson }}
</script>

<style>
  /* lightweight chat bubble style */
  .msg {
    margin: 8px 0;
    max-width: 75%;
    padding: 8px 12px;
    border-radius: 14px;
    line-height: 1.35;
  }
  .msg.user {
    background: #e6f2ff;
    margin-left: auto;
    text-align: right;
  }
  .msg.assistant {
    background: #f5f5f5;
    margin-right: auto;
  }
  .msg.system {
    background: #fff3cd;
    margin: 6px auto;
    text-align: center;
    max-width: 90%;
  }
  .msg .meta {
    display: block;
    font-size: 11px;
    color: #777;
    margin-top: 4px;
  }
  .typing {
    opacity: 0.65;
    font-style: italic;
  }
</style>
<script id="page-context" type="application/json">
  {{ {"pid": pid, "scenario_id": scenario_id} | tojson }}
</script>
<script>
  const ctx = JSON.parse(document.getElementById("page-context").textContent);
  const chatEl = document.getElementById("chat");
  const msgEl = document.getElementById("msg");
  const sendEl = document.getElementById("send");
  const statusEl = document.getElementById("status");

  function bubble(role, text, when) {
    const div = document.createElement("div");
    div.className = `msg ${role}`;
    div.innerHTML = `${escapeHtml(text)}${
      when ? `<span class="meta">${when}</span>` : ""
    }`;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
    return div;
  }

  function escapeHtml(s) {
    return (s || "").replace(
      /[&<>"']/g,
      (m) =>
        ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        }[m])
    );
  }

  async function loadHistory() {
    try {
      const res = await fetch(
        `/api/llm/history?pid=${encodeURIComponent(
          ctx.pid
        )}&scenario_id=${encodeURIComponent(ctx.scenario_id)}`
      );
      const msgs = await res.json();
      chatEl.innerHTML = "";
      msgs.forEach((m) => bubble(m.role, m.content));
    } catch (e) {
      bubble("system", "Could not load history.");
    }
  }

  async function send() {
    const text = msgEl.value.trim();
    if (!text) return;

    // optimistic user bubble
    bubble("user", text);
    msgEl.value = "";
    msgEl.focus();

    // typing indicator
    const typing = bubble("assistant", "…", null);
    typing.classList.add("typing");

    sendEl.disabled = true;
    statusEl.textContent = "Sending…";
    try {
      const res = await fetch("/api/llm/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          pid: ctx.pid,
          scenario_id: ctx.scenario_id,
          input: text,
        }),
      });
      const data = await res.json();
      typing.remove();
      if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);
      bubble("assistant", data.text || "(no reply)");
      statusEl.textContent = "";
    } catch (e) {
      typing.remove();
      bubble("system", `Error: ${e.message}`);
      statusEl.textContent = "Error";
    } finally {
      sendEl.disabled = false;
    }
  }

  sendEl.addEventListener("click", send);
  msgEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });

  loadHistory();
  const wtpIsSecond = {{ (task_order == 'llm_first') | tojson }};
  async function goToNextPage() {
    try {
      await fetch("/api/llm/analyze_final", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pid: ctx.pid, scenario_id: ctx.scenario_id })
      });
    } catch (err) {
      console.error("analyze_final failed:", err);
    }

    window.location.href = wtpIsSecond
      ? {{ url_for_pid('main.page_2_WTP_task') | tojson }}  // WTP was second → go to comparison
      : {{ url_for_pid('main.page_4_comparison') | tojson }};  
      //   window.location.href = {{ url_for_pid('main.page_4_comparison') | tojson }};


      
      }
</script>
