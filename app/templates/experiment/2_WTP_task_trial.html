<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://code.jquery.com/jquery-2.1.1.js"></script>
    <script src="https://code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css?family=Lato:400,300,300italic,100italic,400italic,700"
      rel="stylesheet"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
      integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
      integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp"
      crossorigin="anonymous"
    />
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
      integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
      crossorigin="anonymous"
    ></script>

    <link
      rel="stylesheet"
      media="screen"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <div id="content" class="container-fluid mx-auto" style="width: 800px">
      <h1>Your Scenario</h1>
      <div class="scenario-title" id="scenario-title"></div>
      <div class="scenario-description" id="scenario-text"></div>
      <p>
        Your best strategy is to enter the maximum amount you genuinely believe
        the dataset is worth.
      </p>
      <div id="dataset-info"></div>

      <h4>Prompt:</h4>
      <p>
        <em
          >How much would you be willing to pay for a license to use this
          dataset in your modeling process?<br />
          (Assume a one-time license fee.)</em
        >
      </p>
      <input
        type="number"
        id="user-response"
        placeholder="Enter a bid (0–1000)"
        min="0"
        max="1000"
        step="1"
      />
      <button onclick="submitBid()">Next</button>
      <button onclick="skipBid()">Skip</button>
    </div>
    <script id="trials-page-data" type="application/json">
      {{ {
          "pid": pid,
          "scenario_id": scenario_id,
          "scenario": scenario,
          "trial_index": trial_index,
          "total_trials": total_trials,
          "trial_id": trial_id,
          "trial": trial
      } | tojson }}
    </script>

    <script>
            const TRIALS_DATA = JSON.parse(
              document.getElementById("trials-page-data").textContent
            );
            const {
              pid,
              scenario_id,
              scenario,
              trial_index,
              total_trials,
              trial_id,
              trial,
            } = TRIALS_DATA;

            const titleContainer = document.getElementById("scenario-title");
            //   document.getElementById("scenario-title").innerText = scenario.title;
            const h2 = document.createElement("h2");
            h2.textContent = scenario.title;
            titleContainer.appendChild(h2);

            const textContainer = document.getElementById("scenario-text");
            scenario.text.forEach((paragraph) => {
              const p = document.createElement("p");
              p.textContent = paragraph;
              textContainer.appendChild(p);
            });
            function toInt(val) {
        if (val == null) return null;
        if (typeof val === "number") return Math.round(val);
        const s = String(val).trim().replace(/%/g, "");
        const num = Number(s);
        return Number.isFinite(num) ? Math.round(num) : null;
      }

      function formatPercent(val) {
        const n = val;
        return n == null ? "" : `${n}%`;
      }

      function formatCoverage(val) {
        const n = val;
        return n == null ? "" : `${n} potentially relevant data attributes`;
        
      }

      function plural(n, word) {
        return `${n} ${word}${n === 1 ? "" : "s"}`;
      }

      function formatFrequency(val) {
        if (val == null || val === "") return "";

        // Prefer explicit label if backend ever sends it
        if (typeof val === "string" && /day/i.test(val)) return val;

        // // Named frequency?
        // const nameMatch = typeof val === "string" && FREQ_NAME_TO_DAYS[val];
        // if (nameMatch)
        //   return `${val} (${plural(FREQ_NAME_TO_DAYS[val], "day")})`;

        // Numeric days (e.g., 7 or "7")
        const n = toInt(val);
        if (n != null) {
          // const name = DAYS_TO_FREQ_NAME[String(n)];
          return name ? `${name} (${plural(n, "day")})` : plural(n, "day");
        }

        // Fallback: show raw
        return String(val);
      }

            const info = document.getElementById("dataset-info");



            
        info.innerHTML = `
          <h2>Dataset details for trial ${trial_index}</h2>
          <ul>
            <li><strong>Recommended by:</strong> ${formatPercent(trial.recommendation)}</li>
            <li><strong>Collection frequency:</strong> ${trial.frequency ?? ""}</li>
            <li><strong>Missing data rate:</strong> ${formatPercent(trial.missing) ?? ""}</li>
            <li><strong>Coverage:</strong> ${formatCoverage(trial.coverage) ?? ""}</li>
          </ul>
        `;

        async function submitBid() {
          const raw = document.getElementById("user-response").value.trim();
          const bid = Number(raw);
          if (!Number.isFinite(bid) || bid < 0 || bid > 1000) {
            alert("Enter a number between 0 and 1000");
            return;
          }

          // Save to backend
          const res = await fetch("/api/trials", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ pid, scenario_id, trial: trial_index, bid })
          });
          if (!res.ok) {
            alert("Could not save. Please try again.");
            return;
          }

          // Advance: reload same route for next trial, or finish
          const wtpIsSecond = {{ (task_order == 'llm_first') | tojson }};
          console.log(wtpIsSecond)
          if (trial_index < total_trials) {
            window.location.href = {{ url_for_pid('main.page_2_WTP_task_trial') | tojson }};
          } else {
            window.location.href = wtpIsSecond
            ? {{ url_for_pid('main.page_4_comparison') | tojson }}   // WTP was second → go to comparison
            : {{ url_for_pid('main.page_3_LLM_task') | tojson }}; 
          }
      }
      function skipBid() {
        const wtpIsSecond = {{ (task_order == 'llm_first') | tojson }};
        window.location.href = wtpIsSecond
            ? {{ url_for_pid('main.page_4_comparison') | tojson }}   // WTP was second → go to comparison
            : {{ url_for_pid('main.page_3_LLM_task') | tojson }}; 
      }
    </script>
  </body>
</html>
